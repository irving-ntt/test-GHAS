{
  "flow" : "DOIMSS",
  "id" : "4",
  "steps" :
    [
        {
          	"step_id" : "001",
						"subprocess" : "GENERACIÓN DE CIFRAS CONTROL",
						"description" : [
						"descripcion - Generación de montos resumen,distribuidos por concepto y siefore de acuerdo con las cuentas individuales incluidas en el archivo del trámite",
						"#PARAM@1# = 'P_CX_CRE_ESQUEMA = CIERREN_ETL",
						"#PARAM@2# = 'P_TL_CRE_DISPERSION = TTSISGRAL_ETL_DISPERSION",
						"#PARAM@3# = 'P_CX_CRN_ESQUEMA = CIERREN",
						"#PARAM@4# = 'P_TL_CRN_CONFIG_CONCEP_MOV = TFAFOGRAL_CONFIG_CONCEP_MOV",
						"#PARAM@5# = 'P_SR_FOLIO",
						"#PARAM@6# = 'P_CX_PRO_ESQUEMA = PROCESOS",
						"#PARAM@7# = 'P_TL_PRO_AEIM = TTAFOAE_AEIM ",
						"#PARAM@8# = 'P_TL_VAL_MATRIZ_CONV = TLSISGRAL_ETL_VAL_MATRIZ_CONV"
          ],
          "value": [
					"SELECT "
							,"    C1.FTN_ID_ARCHIVO,"
							,"    C1.FTN_NUM_CTA_INVDUAL,"
							,"    C1.FCN_ID_SIEFORE,"
							,"    C1.FTF_MONTO AS FTF_MONTO_PESOS,"
							,"    C1.FNN_ID_VIV_GARANTIA,"
							,"    C1.FFN_ID_CONCEPTO_MOV,"
							,"    C1.FLN_ID_LIB_APORT,"
							,"    C1.FTN_NSS,"
							,"    C1.FTC_CURP,"
							,"    C1.FTN_ORIGEN_APORTACION,"
							,"    C1.FTN_NO_LINEA,"
							,"    C1.TOTAL,"
							,"    CASE"
							,"        WHEN C1.FTN_NUM_CTA_INVDUAL <> 0 AND C2.FTN_ESTATUS = 1 THEN C2.FTN_ESTATUS"
							,"        WHEN C1.FTN_NUM_CTA_INVDUAL = 0 OR C2.FTN_ESTATUS <> 1 THEN 0"
							,"        ELSE 0 "
							,"    END AS FTN_ESTATUS"
							,"FROM"
							,"    ("
							,"        SELECT "
							,"            D.FTN_ID_ARCHIVO,"
							,"            NVL(D.FTN_NUM_CTA_INVDUAL, 0) AS FTN_NUM_CTA_INVDUAL,"
							,"            D.FCN_ID_SIEFORE,"
							,"            ROUND("
							,"                ("
							,"                    CASE"
							,"                        WHEN CCM.FCN_ID_TIPO_MONTO = 184 THEN D.FTF_MONTO_PESOS"
							,"                        WHEN CCM.FCN_ID_TIPO_MONTO = 199 THEN D.FTF_MONTO_ACCIONES"
							,"                    END"
							,"                ),"
							,"                6"
							,"            ) AS FTF_MONTO,"
							,"            D.FNN_ID_VIV_GARANTIA,"
							,"            D.FFN_ID_CONCEPTO_MOV,"
							,"            D.FLN_ID_LIB_APORT,"
							,"            D.FTN_NSS,"
							,"            D.FTC_CURP,"
							,"            NULL AS FTN_ORIGEN_APORTACION,"
							,"            D.FTN_NO_LINEA,"
							,"            1 AS TOTAL"
							,"        FROM"
							,"            #PARAM@1# D"
							,"            INNER JOIN #PARAM@2# CCM"
							,"             ON CCM.FFN_ID_CONCEPTO_MOV = D.FFN_ID_CONCEPTO_MOV"
							,"        WHERE"
							,"            CCM.FFB_VIGENCIA = 1"
							,"            AND D.FTC_FOLIO = '#PARAM@5#'"
							,"            AND D.FCN_ID_SUBPROCESO NOT IN (118)"
							,"            AND D.FFN_ID_CONCEPTO_MOV NOT IN (231, 637, 638, 1002, 1003)"
							,"            AND ("
							,"                CASE"
							,"                    WHEN D.FCN_ID_SIEFORE IN (82, 83) THEN D.FTF_MONTO_PESOS"
							,"                    ELSE 1"
							,"                END"
							,"            ) > 0"
							,"        UNION"
							,"        SELECT "
							,"            D.FTN_ID_ARCHIVO,"
							,"            NVL("
							,"                ("
							,"                    CASE"
							,"                        WHEN HIST.FTN_ESTATUS_REG = 558 THEN D.FTN_NUM_CTA_INVDUAL"
							,"                        ELSE NULL"
							,"                    END"
							,"                ),"
							,"                0"
							,"            ) AS FTN_NUM_CTA_INVDUAL,"
							,"            D.FCN_ID_SIEFORE,"
							,"            ROUND("
							,"                ("
							,"                    CASE"
							,"                        WHEN CCM.FCN_ID_TIPO_MONTO = 184 THEN D.FTF_MONTO_PESOS"
							,"                        WHEN CCM.FCN_ID_TIPO_MONTO = 199 THEN D.FTF_MONTO_ACCIONES"
							,"                    END"
							,"                ),"
							,"                6"
							,"            ) AS FTF_MONTO,"
							,"            D.FNN_ID_VIV_GARANTIA,"
							,"            D.FFN_ID_CONCEPTO_MOV,"
							,"            D.FLN_ID_LIB_APORT,"
							,"            D.FTN_NSS,"
							,"            D.FTC_CURP,"
							,"            NULL AS FTN_ORIGEN_APORTACION,"
							,"            D.FTN_NO_LINEA,"
							,"            1 AS TOTAL"
							,"        FROM"
							,"            #PARAM@1# D"
							,"            INNER JOIN  #PARAM@2# CCM "
							,"            ON CCM.FFN_ID_CONCEPTO_MOV = D.FFN_ID_CONCEPTO_MOV"
							,"            LEFT OUTER JOIN #PARAM@3# HIST   "
							,"             ON ("
							,"                DECODE(LENGTH(TRIM(D.FTC_NOMBRE)), NULL, '1', TRIM(D.FTC_NOMBRE)) = DECODE(LENGTH(TRIM(HIST.FTC_NOMBRE_COMPLETO_ARCH)), NULL, '1', TRIM(HIST.FTC_NOMBRE_COMPLETO_ARCH))"
							,"                AND DECODE(LENGTH(TRIM(D.FTN_NSS)), NULL, '1', TRIM(D.FTN_NSS)) = DECODE(LENGTH(TRIM(HIST.FTN_NSS_ARCH)), NULL, '1', TRIM(HIST.FTN_NSS_ARCH))"
							,"                AND DECODE(LENGTH(TRIM(D.FTC_RFC)), NULL, '1', TRIM(D.FTC_RFC)) = DECODE(LENGTH(TRIM(HIST.FTC_RFC_ARCH)), NULL, '1', TRIM(HIST.FTC_RFC_ARCH))"
							,"                AND DECODE(LENGTH(TRIM(D.FCN_REG_PATRONAL_IMSS)), NULL, '1', TRIM(D.FCN_REG_PATRONAL_IMSS)) = DECODE(LENGTH(TRIM(HIST.FNC_REG_PATRONAL_IMSS)), NULL, '1', TRIM(HIST.FNC_REG_PATRONAL_IMSS))"
							,"            )"
							,"        WHERE"
							,"            D.FTC_FOLIO = '#PARAM@5#'"
							,"            AND D.FCN_ID_SUBPROCESO IN (118)"
							,"            AND D.FFN_ID_CONCEPTO_MOV NOT IN (231, 637, 638, 1002, 1003)"
							,"            AND ("
							,"                CASE"
							,"                    WHEN D.FCN_ID_SIEFORE IN (82, 83) THEN D.FTF_MONTO_PESOS"
							,"                    ELSE 1"
							,"                END"
							,"            ) > 0"
							,"    ) C1"
							,"    LEFT JOIN ("
							,"        SELECT"
							,"            FTN_NUM_CTA_INVDUAL,"
							,"            1 AS FTN_ESTATUS"
							,"        FROM"
							,"            #PARAM@4#"
							,"        WHERE"
							,"            FTC_FOLIO = '#PARAM@5#'"
							,"            AND FTB_ESTATUS_MARCA IN (1, 2)"
							,"    ) C2 ON C1.FTN_NUM_CTA_INVDUAL = C2.FTN_NUM_CTA_INVDUAL"
          ]
        },
		{
			"step_id" : "002",
				"subprocess" : "GENERACIÓN DE CIFRAS CONTROL",
				"description" : ["Generación de montos resumen,distribuidos por concepto y siefore de acuerdo con las cuentas individuales incluidas en el archivo del trámite"],
			"value" : [
					 "WITH TEMP_CONCILIACIONES_CIFRAS AS ("
					,"    SELECT"
					,"        FTN_NUM_CTA_INVDUAL,"
					,"        CASE"
					,"           WHEN FTN_NUM_CTA_INVDUAL <> 0 AND FTN_ESTATUS = 1 THEN FTN_ESTATUS"
					,"           WHEN FTN_NUM_CTA_INVDUAL = 0 OR FTN_ESTATUS <> 1 THEN 0"
					,"        END AS FTN_ESTATUS,"
					,"        FCN_ID_SIEFORE,"
					,"        FTF_MONTO_PESOS,"
					,"        FFN_ID_CONCEPTO_MOV,"
					,"        FTN_ORIGEN_APORTACION,"
					,"        FLN_ID_LIB_APORT,"
					,"        FNN_ID_VIV_GARANTIA,"
					,"        FTN_ID_ARCHIVO,"
					,"        FTN_NSS,"
					,"        FTC_CURP,"
					,"        TOTAL,"
					,"        ROW_NUMBER() OVER (ORDER BY NULL) AS FTN_NO_LINEA"
					,"    FROM"
					,"    ("
					,"       SELECT"
					,"         C1.FTN_NUM_CTA_INVDUAL,"
					,"         C1.FCN_ID_SIEFORE,"
					,"         C1.FTF_MONTO_PESOS,"
					,"         C1.FTC_FOLIO,"
					,"         C1.FTN_ORIGEN_APORTACION,"
					,"         C2.FTN_ESTATUS,"
					,"         C1.FCN_ID_TIPO_SUBCTA,"
					,"         C1.FLN_ID_LIB_APORT,"
					,"         C1.FNN_ID_VIV_GARANTIA,"
					,"         C1.FTN_ID_ARCHIVO,"
					,"         C1.FTN_NSS,"
					,"         C1.FTC_CURP,"
					,"         C1.TOTAL,"
					,"         C3.FFN_ID_CONCEPTO_MOV"
					,"        FROM"
					,"      ("
					,"/*----------------- EXTRACCIÓN DE REGISTROS DOMIS EN CONCILIACION -------------------------------*/"
					,"/*------------------------- (DB_300_CONCILIACION_DOMIS) -----------------------------------------*/"
					,"          SELECT /*+ PARALLEL(8) */"
					,"       CON.FTC_FOLIO"
					,"           ,NVL((CASE WHEN SOL.FTN_ESTATUS_CARGO = #PARAM@1# THEN CON.FTN_NUM_CTA_INVDUAL ELSE NULL END),0) FTN_NUM_CTA_INVDUAL "
					,"      ,CON.FTN_ORIGEN_APORTACION"
					,"            ,DIV.FTN_MONTO FTF_MONTO_PESOS"
					,"             ,TSU.FCN_ID_TIPO_SUBCTA"
					,"            ,#PARAM@2# FLN_ID_LIB_APORT"
					,"            ,NULL FNN_ID_VIV_GARANTIA"
					,"            ,AF.FTN_ID_ARCHIVO"
					,"            ,CON.FTN_NSS"
					,"            ,CON.FTC_CURP"
					,"           ,DECODE(TSU.FCN_ID_SIEFORE,NULL,758,TSU.FCN_ID_SIEFORE) FCN_ID_SIEFORE"
					,"            ,TOTAL"
					,"         FROM  #PARAM@3# CON"
					,"        INNER JOIN  #PARAM@4# AF ON CON.FTC_FOLIO = AF.FTC_FOLIO"
					,"        INNER JOIN #PARAM@5# SOL ON CON.FTN_CVE_SOLICITUD = SOL.FTC_CVE_SOLICITUD"
					,"        LEFT JOIN (SELECT FTC_CVE_SOLICITUD,FTN_ESTATUS_CARGO,COUNT(*) TOTAL"
					,"                          FROM #PARAM@6# WHERE FTC_FOLIO_ARCHIVO ='#PARAM@7#'"
					,"                          AND FTN_ESTATUS_CARGO = 500"
					,"                          GROUP BY FTC_CVE_SOLICITUD,FTN_ESTATUS_CARGO) T1" 
					,"         ON T1.FTC_CVE_SOLICITUD=CON.FTN_CVE_SOLICITUD"
					,"        LEFT OUTER JOIN (SELECT TO_CHAR(DCO.FTN_ID_CONCILIACION) CVE_GEN"
					,"                     ,REF.FTN_REF_SUBCTA_APOVOL"
					,"                    ,DCO.FTN_PORCENTAJE"
					,"                     ,DCO.FTN_MONTO"
					,"                    FROM  #PARAM@8# DCO"
					,"                    ,(SELECT TMN_CVE_ITGY, TMN_CVE_NCI FTN_REF_SUBCTA_APOVOL FROM #PARAM@9# WHERE 1=1 AND TMC_USO='REFERENCIAS FONDO APOVOL') REF"
					,"                     WHERE 1=1  AND   DCO.FTN_FONDO_APOVOL = REF.TMN_CVE_ITGY"
					,"                   ) DIV"
					,"            ON CON.FTN_ID_CONCILIACION = DIV.CVE_GEN"
					,"           LEFT OUTER JOIN (SELECT  SUBC.FCN_ID_CAT_SUBCTA"
					,"            ,SUBC.FCN_ID_TIPO_SUBCTA"
					,"            ,S.FCN_ID_SIEFORE"
					,"               FROM #PARAM@10# SUBC"
					,"                    ,#PARAM@11# TC"
					,"                    ,#PARAM@12# CAT"
					,"                    ,#PARAM@13# S"
					,"               WHERE  SUBC.FCN_ID_REGIMEN = CAT.FCN_ID_CAT_CATALOGO"
					,"             AND    TC.FCN_ID_TIPO_CAT = CAT.FCN_ID_TIPO_CAT"
					,"             AND    S.FCN_ID_GRUPO = SUBC.FCN_ID_GRUPO"
					,"             AND    TC.FCN_ID_TIPO_CAT = 21"
					,"          AND    TC.FCB_VIGENCIA = 1 "
					,"         AND    CAT.FCB_VIGENCIA = 1"
					,"           ) TSU" 
					,"             ON COALESCE(DIV.FTN_REF_SUBCTA_APOVOL, CON.FTN_REF_SUBCTA_APOVOL) = TSU.FCN_ID_CAT_SUBCTA"
					,"          WHERE CON.FTC_FOLIO ='#PARAM@7#' AND  CON.FTN_ORIGEN_APORTACION NOT IN (287,288,289,290,292,293)"
					,"UNION ALL   "
					,"/*-- REGISTROS DOMIS RECHAZADOS POR BANCO Y MONTO PENDIENTE POR RECAUDAR*/"
					,"  SELECT /*+ PARALLEL(8) */ "
					,"             DOMI.FTC_FOLIO"
					,"            ,0 FTN_NUM_CTA_INVDUAL "
					,"            ,SOL.FTN_ORIGEN_APORTACION"
					,"            ,CASE WHEN NVL(RDS.FTN_MONTO_REC,0)=0 THEN DIV.FTN_MONTO ELSE (DIV.FTN_MONTO-RDS.FTN_MONTO_DIV)  END FTF_MONTO_PESOS /*--SI NO HAY MONTO RECAUDADO SE RECHAZA ESE MONTO, SI HAY MONTO SE RESTA LA DIVERSIFICACIÓN CON LA DIVERSIFICACIÓN RECAUDADA*/"
					,"            ,TSU.FCN_ID_TIPO_SUBCTA"
					,"            ,#PARAM@2# FLN_ID_LIB_APORT"
					,"            ,NULL FNN_ID_VIV_GARANTIA               "
					,"            ,DOMI.FTN_ID_ARCHIVO"
					,"            ,SOL.FTN_NSS"
					,"            ,SOL.FTC_CURP"
					,"            ,TSU.FCN_ID_SIEFORE"
					,"            ,TOTAL"
					,"  FROM  (SELECT DISTINCT A.FTC_CVE_SOLICITUD , B.FTC_ID_CARGO , A.FTN_ID_ARCHIVO , A.FTC_FOLIO ,TOTAL"
					,"                         FROM #PARAM@14# A"
					,"                         INNER JOIN  (SELECT  FTC_ID_CARGO,FTC_CVE_SOLICITUD,COUNT(*) TOTAL"
					,"                         FROM #PARAM@6#"
					,"                         WHERE  FTC_FOLIO_ARCHIVO ='#PARAM@7#' AND FTN_ESTATUS_CARGO = 501"
					,"                         GROUP BY FTC_ID_CARGO,FTC_CVE_SOLICITUD ) B ON ( A.FTC_CVE_SOLICITUD = B.FTC_CVE_SOLICITUD)"
					,"                  WHERE   FTN_TIPO_REGISTRO = 2"
					,"                  AND     FTC_FOLIO ='#PARAM@7#'"
					,"                  AND    (FTN_CODIGO_TIPO_MOV = 31 OR FTN_MOTIVO_DEV <> 0)"
					,"             ) DOMI"
					,"  INNER JOIN #PARAM@5# SOL ON DOMI.FTC_CVE_SOLICITUD = SOL.FTC_CVE_SOLICITUD"
					,"  INNER JOIN #PARAM@15# RDS ON "
					,"                 (DOMI.FTC_CVE_SOLICITUD = RDS.FTC_CVE_SOLICITUD AND DOMI.FTC_ID_CARGO= RDS.FTC_ID_CARGO AND  DOMI.FTC_CVE_SOLICITUD= RDS.FTC_CVE_SOLICITUD)"
					,"  LEFT OUTER JOIN "
					,"  ("
					,"          SELECT DCO.FTC_CVE_SOLICITUD"
					,"                    ,NVL (MAP.TMN_CVE_NCI, '0000') FTN_FONDO_APOVOL"
					,"                    ,DCO.FTN_FONDO_APOVOL AS FONDO_APOVOL_DIV_SOL"
					,"                    ,DCO.FTN_PORCENTAJE"
					,"              ,DCO.FTN_MONTO"
					,"          FROM  #PARAM@16# DCO"
					,"                   ,#PARAM@9# MAP"
					,"          WHERE 1=1"
					,"          AND   DCO.FTN_FONDO_APOVOL = MAP.TMN_CVE_ITGY(+)"
					,"          AND   MAP.TMC_USO = 'REFERENCIAS FONDO APOVOL'"
					,"          AND   DCO.FTN_VIGENCIA = 1"
					,"  ) DIV ON (DOMI.FTC_CVE_SOLICITUD = DIV.FTC_CVE_SOLICITUD AND DIV.FONDO_APOVOL_DIV_SOL=RDS.FTN_FONDO_APOVOL)"
					,"  LEFT OUTER JOIN "
					,"  ("
					,"          SELECT  SUBC.FCN_ID_CAT_SUBCTA"
					,"                  ,SUBC.FCN_ID_TIPO_SUBCTA"
					,"                  ,S.FCN_ID_SIEFORE"
					,"          FROM #PARAM@10# SUBC"
					,"           ,#PARAM@11# TC"
					,"           ,#PARAM@12# CAT"
					,"           ,#PARAM@13# S"
					,"          WHERE  SUBC.FCN_ID_REGIMEN = CAT.FCN_ID_CAT_CATALOGO"
					,"          AND    TC.FCN_ID_TIPO_CAT = CAT.FCN_ID_TIPO_CAT"
					,"          AND    S.FCN_ID_GRUPO = SUBC.FCN_ID_GRUPO"
					,"          AND    TC.FCN_ID_TIPO_CAT = 21"
					,"          AND    TC.FCB_VIGENCIA = 1 "
					,"          AND    CAT.FCB_VIGENCIA = 1"
					,"  ) TSU ON DIV.FTN_FONDO_APOVOL = TSU.FCN_ID_CAT_SUBCTA"
					,"UNION ALL"
					,"/*-- REGISTROS DE NOMINA Y REDES COMERCIALES*/"
					,"  SELECT /*+ PARALLEL(8) */"
					,"       CON.FTC_FOLIO"
					,"       ,CASE WHEN (CON.FTN_ORIGEN_APORTACION =290 AND CON.FTN_ESTATUS_TRAMITE = 968) THEN 0 ELSE CON.FTN_NUM_CTA_INVDUAL END AS FTN_NUM_CTA_INVDUAL"
					,"       ,CON.FTN_ORIGEN_APORTACION"
					,"       ,CON.FTN_IMPORTE FTF_MONTO_PESOS"
					,"       ,TSU.FCN_ID_TIPO_SUBCTA"
					,"       ,#PARAM@2# FLN_ID_LIB_APORT"
					,"       ,NULL FNN_ID_VIV_GARANTIA"
					,"       ,AF.FTN_ID_ARCHIVO"
					,"       ,CON.FTN_NSS"
					,"       ,CON.FTC_CURP"
					,"       ,OSS.FCN_ID_SIEFORE"
					,"       ,1 TOTAL"
					,"  FROM  #PARAM@3# CON"
					,"  INNER JOIN #PARAM@4# AF ON CON.FTC_FOLIO = AF.FTC_FOLIO"
					,"  LEFT OUTER JOIN "
					,"  ("
					,"          SELECT  SUBC.FCN_ID_CAT_SUBCTA"
					,"                 ,SUBC.FCN_ID_GRUPO"
					,"                 ,SUBC.FCN_ID_TIPO_SUBCTA"
					,"          FROM  #PARAM@10# SUBC"
					,"                ,#PARAM@11# TC"
					,"                ,#PARAM@12# CAT"
					,"          WHERE  SUBC.FCN_ID_REGIMEN = CAT.FCN_ID_CAT_CATALOGO"
					,"          AND    TC.FCN_ID_TIPO_CAT = CAT.FCN_ID_TIPO_CAT"
					,"          AND    TC.FCN_ID_TIPO_CAT = 21"
					,"          AND    TC.FCB_VIGENCIA = 1 "
					,"          AND    CAT.FCB_VIGENCIA = 1"
					,"  ) TSU ON CON.FTN_REF_SUBCTA_APOVOL = TSU.FCN_ID_CAT_SUBCTA"
					,"  LEFT OUTER JOIN "
					,"  ("
					,"          SELECT O.FCN_ID_SIEFORE, "
					,"                 O.FCN_ID_GRUPO, "
					,"                 O.FTN_NUM_CTA_INVDUAL"
					,"          FROM  #PARAM@17# O"
					,"                 ,#PARAM@13# S"
					,"          WHERE 1 = 1"
					,"          AND   O.FCN_ID_SIEFORE = S.FCN_ID_SIEFORE"
					,"          AND   O.FTC_ESTATUS = 1 "
					,"          AND   O.FTN_PRIORIDAD = 1"
					,"          AND   S.FCC_VIGENCIA = 1 "
					,"  ) OSS ON (TSU.FCN_ID_GRUPO = OSS.FCN_ID_GRUPO AND CON.FTN_NUM_CTA_INVDUAL = OSS.FTN_NUM_CTA_INVDUAL)"
					,"  WHERE CON.FTC_FOLIO ='#PARAM@7#'"
					,"  AND   CON.FTN_ORIGEN_APORTACION IN (289,290)"
					,"/* ---- EXTRACCIÓN DE REGISTROS CONCILIACIÓN ESAR PARA UNIRSE CON LAS CONCILIACIONES DOIMSS-------*/"
					,"/*------------------------- (DB_300_CONCILIACION_ESAR) ------------------------------------------*/"
					,"UNION ALL"
					,"SELECT /*+ PARALLEL(8) */"
					,"    PRE.FTC_FOLIO"
					,"   ,NVL((CASE WHEN PRE.FTN_ESTATUS_SOLICITUD = #PARAM@18#"
					,"   OR VAL.FTN_ESTATUS_VALIDACION = #PARAM@19# THEN NULL"
					,"          ELSE PRE.FTN_NUM_CTA_INVDUAL"
					,"          END),0) FTN_NUM_CTA_INVDUAL"
					,"   ,844 FTN_ORIGEN_APORTACION"
					,"   ,NVL(COALESCE(DIV.FTN_MONTO,PRE.FTN_IMPORTE),0) FTF_MONTO_PESOS"
					,"   ,TSU.FCN_ID_TIPO_SUBCTA"
					,"   ,#PARAM@2# FLN_ID_LIB_APORT"
					,"   ,NULL FNN_ID_VIV_GARANTIA"
					,"   ,AF.FTN_ID_ARCHIVO"
					,"   ,PRE.FTN_NSS"
					,"   ,PRE.FTC_CURP"
					,"   ,OSS.FCN_ID_SIEFORE "
					,"   ,1 TOTAL"
					," FROM   #PARAM@20# PRE"
					," INNER JOIN #PARAM@4# AF ON PRE.FTC_FOLIO = AF.FTC_FOLIO"
					," LEFT OUTER JOIN #PARAM@21# VAL ON ( PRE.FTC_FOLIO = VAL.FTC_FOLIO_LOTE"
					,"   AND PRE.FTC_CVE_SOLICITUD = VAL.FTC_FOLIO AND VAL.FTN_TIPO_VALIDACION = #PARAM@22# )"
					,"  LEFT OUTER JOIN "
					,"  ("
					,"          SELECT DSO.FTC_CVE_SOLICITUD"
					,"                ,REF.FTN_REF_SUBCTA_APOVOL"
					,"                ,DSO.FTN_PORCENTAJE"
					,"                ,DSO.FTN_MONTO"
					,"          FROM #PARAM@23# DSO"
					,"                   ,(SELECT TMN_CVE_ITGY, TMN_CVE_NCI FTN_REF_SUBCTA_APOVOL"
					,"                    FROM  #PARAM@9# WHERE 1=1 AND TMC_USO='REFERENCIAS FONDO APOVOL') REF"
					,"          WHERE 1=1"
					,"          AND   DSO.FTN_FONDO_APOVOL = REF.TMN_CVE_ITGY"
					,"  ) DIV ON PRE.FTC_CVE_SOLICITUD = DIV.FTC_CVE_SOLICITUD"
					,"  LEFT OUTER JOIN "
					,"  ("
					,"          SELECT  SUBC.FCN_ID_CAT_SUBCTA"
					,"                     ,SUBC.FCN_ID_GRUPO"
					,"                     ,SUBC.FCN_ID_TIPO_SUBCTA"
					,"          FROM  #PARAM@10# SUBC"
					,"                    ,#PARAM@11# TC"
					,"                    ,#PARAM@12# CAT"
					,"          WHERE  SUBC.FCN_ID_REGIMEN = CAT.FCN_ID_CAT_CATALOGO"
					,"          AND    TC.FCN_ID_TIPO_CAT = CAT.FCN_ID_TIPO_CAT"
					,"          AND    TC.FCN_ID_TIPO_CAT = 21"
					,"          AND    TC.FCB_VIGENCIA = 1 "
					,"          AND    CAT.FCB_VIGENCIA = 1"
					,"  ) TSU ON DIV.FTN_REF_SUBCTA_APOVOL = TSU.FCN_ID_CAT_SUBCTA"
					,"  LEFT OUTER JOIN "
					,"  ("
					,"          SELECT O.FCN_ID_SIEFORE, "
					,"                     O.FCN_ID_GRUPO, "
					,"                     O.FTN_NUM_CTA_INVDUAL"
					,"          FROM #PARAM@17#  O"
					,"                    ,#PARAM@13#  S"
					,"          WHERE 1 = 1"
					,"          AND   O.FCN_ID_SIEFORE = S.FCN_ID_SIEFORE"
					,"          AND   O.FTC_ESTATUS = 1 "
					,"          AND   O.FTN_PRIORIDAD = 1"
					,"          AND   S.FCC_VIGENCIA = 1 "
					,"  ) OSS ON (TSU.FCN_ID_GRUPO = OSS.FCN_ID_GRUPO AND PRE.FTN_NUM_CTA_INVDUAL = OSS.FTN_NUM_CTA_INVDUAL)"
					,"  WHERE PRE.FTC_FOLIO ='#PARAM@7#'"
					,") C1"
					,"/*--- EXTRACCIÓN DE REGISTROS MARCADOS EN LA TABLA DE MATRIZ PARA UNIRLOS CON LAS CONCILIACIONES ----*/"
					,"/*-------------------- (DB_100_TTSISGRAL_ETL_MATRIZ_IDENT) ------------------------------------------*/"
					,"    LEFT JOIN"
					,"    ("
					,"        SELECT"
					,"            FTN_NUM_CTA_INVDUAL,"
					,"            1 AS FTN_ESTATUS"
					,"        FROM"
					,"             #PARAM@24#"
					,"        WHERE"
					,"            FTC_FOLIO = '#PARAM@7#'"
					,"            AND FTB_ESTATUS_MARCA IN (1, 2)"
					,"    ) C2 ON C1.FTN_NUM_CTA_INVDUAL = C2.FTN_NUM_CTA_INVDUAL"
					,"/*-- EXTRACCIÓN DE LOS CONCEPTOS DE MOVIMIENTOS PARA UNIRLOS CON LAS CONCILIACIONES MARCADAS EN MATRIZ ----*/"
					,"/*-------------------- (DB_500_CONCEPTO_MOV) ------------------------------------------------*/"
					,"    INNER JOIN"
					,"    ("
					,"        SELECT"
					,"                FFN_ID_CONCEPTO_MOV,"
					,"                FTN_ORIGEN AS FTN_ORIGEN_APORTACION,"
					,"                FCN_ID_TIPO_SUBCTA"
					,"        FROM "
					,"        #PARAM@25# A"
					,"        ,#PARAM@26# B"
					,"        WHERE 1=1"
					,"        AND A.FRN_ID_MOV_SUBCTA=B.FRN_ID_MOV_SUBCTA"
					,"        AND FCN_ID_SUBPROCESO=101"
					,"        AND A.FRB_VIGENCIA=1"
					,"    ) C3 ON C1.FTN_ORIGEN_APORTACION = C3.FTN_ORIGEN_APORTACION AND C1.FCN_ID_TIPO_SUBCTA = C3.FCN_ID_TIPO_SUBCTA"
					,")"
					,")"
					,"SELECT"
					,"  FCN_ID_SIEFORE,"
					,"  FTF_MONTO_PESOS,"
					,"  FTN_ESTATUS,"
					,"  FFN_ID_CONCEPTO_MOV,"
					,"  FLN_ID_LIB_APORT,"
					,"  FNN_ID_VIV_GARANTIA,"
					,"  FTN_ID_ARCHIVO,"
					,"  FTN_NUM_CTA_INVDUAL,"
					,"  FTN_NSS,"
					,"  FTC_CURP,"
					,"  FTN_ORIGEN_APORTACION,"
					,"  FTN_NO_LINEA,"
					,"  TOTAL"
					," FROM TEMP_CONCILIACIONES_CIFRAS"
			]
		},
{
         "step_id" : "003",
         "subprocess" : "GENERACIÓN DE CIFRAS CONTROL",
         "description" : "Generación de montos resumen,distribuidos por concepto y siefore de acuerdo con las cuentas individuales incluidas en el archivo del trámite",
         "value" : [
             "/*---LA SALIDA DE LA UNIÓN DEBE ALMACENARSE EN LA TABLA TEMPORAL TEMP_UNION_DISP_CONCI*/"
                ,"SELECT"
                ,"FTN_ID_ARCHIVO,"
                ,"FTN_NUM_CTA_INVDUAL,"
                ,"FCN_ID_SIEFORE,"
                ,"FTF_MONTO_PESOS,"
                ,"FNN_ID_VIV_GARANTIA,"
                ,"FFN_ID_CONCEPTO_MOV,"
                ,"FLN_ID_LIB_APORT,"
                ,"FTN_NSS,"
                ,"FTC_CURP,"
                ,"FTN_ORIGEN_APORTACION,"
                ,"FTN_NO_LINEA,"
                ,"TOTAL,"
                ,"FTN_ESTATUS"
                ,"FROM #PARAM@1#"
                ,"UNION ALL"
                ,"SELECT"
								,"FTN_ID_ARCHIVO,"
								,"FTN_NUM_CTA_INVDUAL,"
                ,"FCN_ID_SIEFORE,"
                ,"FTF_MONTO_PESOS,"
								,"FNN_ID_VIV_GARANTIA,"
								,"FFN_ID_CONCEPTO_MOV,"
								,"FLN_ID_LIB_APORT,"
                ,"FTN_NSS,"
                ,"FTC_CURP,"
                ,"FTN_ORIGEN_APORTACION,"
                ,"FTN_NO_LINEA,"
                ,"TOTAL,"
                ,"FTN_ESTATUS"
                ,"FROM #PARAM@2#;"
	 ]
	},
	 {
         "step_id" : "004",
         "subprocess" : "GENERACIÓN DE CIFRAS CONTROL",
         "description" : "Generación de montos resumen,distribuidos por concepto y siefore de acuerdo con las cuentas individuales incluidas en el archivo del trámite",
         "value" : [
				        "SELECT"
                ,"    FTC_FOLIO,"
                ,"    COUNT(CASE WHEN FNN_ID_VIV_GARANTIA = 0 THEN 1 END) AS REGSINCREDITO,"
                ,"    COUNT(CASE WHEN FNN_ID_VIV_GARANTIA = 1 THEN 1 END) AS REGISTROSCONCREDITO"
                ,"FROM ("
                ,"    SELECT"
                ,"        D.FTC_FOLIO,"
                ,"        D.FTN_NUM_CTA_INVDUAL,"
                ,"        MAX(D.FNN_ID_VIV_GARANTIA)FNN_ID_VIV_GARANTIA"
                ,"    FROM #PARAM@1# D"
                ,"    INNER JOIN" 
                ,"    #PARAM@2# MCV"
                ,"     ON D.FTN_NUM_CTA_INVDUAL = MCV.FTN_NUM_CTA_INVDUAL AND D.FTC_FOLIO=MCV.FTC_FOLIO"
                ,"    WHERE D.FTC_FOLIO = '#PARAM@3#' "
                ,"    AND (MCV.FTB_ESTATUS_MARCA = 1 OR MCV.FTB_ESTATUS_MARCA = 2)"
                ,"    GROUP BY D.FTC_FOLIO,D.FTN_NUM_CTA_INVDUAL"
                ,"    )"
                ,"GROUP BY FTC_FOLIO"	
				 ]
			},
	        {
         "step_id" : "005",
         "subprocess" : "GENERACIÓN DE CIFRAS CONTROL",
         "description" : "Generación de montos resumen,distribuidos por concepto y siefore de acuerdo con las cuentas individuales incluidas en el archivo del trámite",
         "value" : [
             "SELECT"
                ,"  FTN_ID_ARCHIVO,"
                ,"  '#PARAM@1#' AS FTC_FOLIO,"
                ,"  TOTAL_IMPORTES.FCN_ID_SIEFORE,"
                ,"  FLN_ID_LIB_APORT,"
                ,"  FFN_ID_CONCEPTO_MOV AS FLN_ID_CONCEPTO_IMP,"
                ,"  CASE WHEN FNN_ID_VIV_GARANTIA = 0 THEN '0'"
                ,"  WHEN FNN_ID_VIV_GARANTIA = 1 THEN '1' ELSE NULL"
                ,"  END AS  FLB_ID_CRED_VIV,"
                ,"  CASE WHEN TOTAL_REGISTROS.FTN_ESTATUS = 1 THEN TOTAL_MONTO ELSE 0 END AS FLN_IMPORTE_ACEP,"
                ,"  CASE WHEN TOTAL_REGISTROS.FTN_ESTATUS = 1 THEN TOTAL_REGS ELSE 0 END AS FLN_NUM_REG,"
                ,"  CASE WHEN TOTAL_REGISTROS.FTN_ESTATUS = 0 OR TOTAL_REGISTROS.FTN_ESTATUS IS NULL THEN TOTAL_MONTO ELSE 0 END AS FLN_IMPORTE_RECH,"
                ,"  CASE WHEN TOTAL_REGISTROS.FTN_ESTATUS = 0 OR TOTAL_REGISTROS.FTN_ESTATUS IS NULL THEN NVL(TOTAL_REGS, 0)ELSE 0 END AS FLN_NUM_REG_RECH,"
                ,"  FTN_ORIGEN_APORTACION,"
                ,"  'DATABRICKS' AS FLC_USU_REG,"
                ,"   /*date_format(current_timestamp(),'dd/MM/yy HH:mm:ss') AS FLD_FEC_REG,*/"
								,"   to_timestamp(from_utc_timestamp(CURRENT_TIMESTAMP, 'GMT-6')) AS FLD_FEC_REG,"
                ,"   CONTEO.REGSINCREDITO AS FLN_NUM_REG_SINCREDITO,"
                ,"   CONTEO.REGISTROSCONCREDITO AS FLN_NUM_REG_CONCREDITO"
                ,"FROM"
                ,"   ("
                ,"  SELECT"
                ,"   FCN_ID_SIEFORE,"
                ,"   FTN_ESTATUS,"
                ,"   SUM(TOTAL) AS TOTAL_REGS"
                ,"   FROM"
                ,"(SELECT DISTINCT"
                ,"   FCN_ID_SIEFORE,"
                ,"   FTN_ESTATUS,"
                ,"   FTN_NO_LINEA,"
                ,"   TOTAL"
                ,"   FROM #PARAM@2#"
                ,"  WHERE '#PARAM@3#' = '101' OR ('#PARAM@3#' <> '101' AND (((FCN_ID_SIEFORE = 82 OR FCN_ID_SIEFORE = 83) AND  FTN_ESTATUS <> 0) OR (FCN_ID_SIEFORE <> 82 AND FCN_ID_SIEFORE <> 83 )))"
                ,") GROUP BY FCN_ID_SIEFORE, FTN_ESTATUS"
                ,"  ) TOTAL_REGISTROS  /*--- OBTIENE EL TOTAL DE REGISTROS*/"
                ,"RIGHT JOIN "
                ,"  ("
                ,"          SELECT"
                ,"          SUM(FTF_MONTO_PESOS) AS TOTAL_MONTO,"
                ,"          FCN_ID_SIEFORE,"
                ,"          FFN_ID_CONCEPTO_MOV,"
                ,"          FLN_ID_LIB_APORT,"
                ,"          FNN_ID_VIV_GARANTIA,"
                ,"          FTN_ESTATUS,"
                ,"          FTN_ID_ARCHIVO,"
                ,"          FTN_ORIGEN_APORTACION"
                ,"   FROM #PARAM@2#"
                ,"   GROUP BY "
                ,"          FCN_ID_SIEFORE,"
                ,"          FFN_ID_CONCEPTO_MOV,"
                ,"          FLN_ID_LIB_APORT,"
                ,"          FNN_ID_VIV_GARANTIA,"
                ,"          FTN_ESTATUS,"
                ,"          FTN_ID_ARCHIVO,"
                ,"          FTN_ORIGEN_APORTACION"
                ,"  ) TOTAL_IMPORTES /*-- OBTIENE EL TOTAL DE IMPORTES (AG_510_TOTAL_IMPORTES) -- RIGHT*/"
                ,"ON TOTAL_REGISTROS.FCN_ID_SIEFORE = TOTAL_IMPORTES.FCN_ID_SIEFORE AND TOTAL_REGISTROS.FTN_ESTATUS = TOTAL_IMPORTES.FTN_ESTATUS"
				        ,"LEFT JOIN /*--- SE AGREGA EL SEGMENTO PARA EVITAR EL UPDATE EN EL SIGUIENTE PASO*/"
								,"#PARAM@4# CONTEO"
								,"ON  CONTEO.FTC_FOLIO = '#PARAM@1#'"
          ]
          },
       {
          "step_id" : "006",
          "source" : "oracle",
		      "description" : "Antes de insertar la información, asegura que la información no exista.",
          "value" : [
              "DELETE FROM CIERREN.TLAFOGRAL_SUMARIO_ARCHIVO WHERE FTC_FOLIO = '#PARAM@1#'"
          ]
        }      
  ]
}