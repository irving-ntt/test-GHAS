SELECT 
  FTC_TIPO_TRANSF,
  FTD_FEH_PRESEN,
  FTD_FEH_MOVI,
  FTC_CURP,
  FTC_NSS_AFORE,
  FTC_APELLIDO_PATER_AFORE,
  FTC_APELLIDO_MATER_AFORE,
  FTC_NOMBRE_AFORE,
  FTC_NOMBRE_IMSS,
  FTC_RFC_INFONA,
  FTN_NUM_CRED_INFONA,
  FTC_IDENTI_LOTE_DEV,
  FTN_AIVS_VIV_92,
  FTN_SALDO_92,
  FTN_INTERES_SALDO_92,
  FTN_AIVS_VIV_97,
  FTN_SALDO_97,
  FTN_INTERES_SALDO_97,
  FTD_FEH_VAL_VIV,
	FTC_ESTATUS,
	FTC_IDENTI_ASIG,
  FTC_TIPO_DEV,
  FTC_NSS_SEPAR_CTA,
  FTC_ORIGEN_DEV,
  FTN_MONTO_APORTA,
  FTN_APLIC_INT_APORTA,
  FTC_FOLIO,
  FTN_ID_ARCHIVO,
  FTC_TIPO_ARCH,
  FTN_CONTA_SERV,
  FCN_ID_SUBPROCESO,
	FTD_FEH_CRE,
	FTC_USU_CRE,
	FTN_CTA_AFORE,
	FTC_INDI_VIVI,
	FTD_REGI_INDI,
	FCN_ID_MOTIVO_RECHAZO,
	FTC_CELULAR,
	FTC_CORREO_ELEC
FROM (
    SELECT 
       FTC_TIPO_TRANSF,
       FTD_FEH_PRESEN,
       FTD_FEH_MOVI,
       FTC_CURP,
       FTC_NSS_AFORE,
       FTC_APELLIDO_PATER_AFORE,
       FTC_APELLIDO_MATER_AFORE,
       FTC_NOMBRE_AFORE,
       FTC_NOMBRE_IMSS,
       FTC_RFC_INFONA,
       FTN_NUM_CRED_INFONA,
       FTC_IDENTI_LOTE_DEV,
       FTN_AIVS_VIV_92,
       FTN_SALDO_92,
       FTN_INTERES_SALDO_92,
       FTN_AIVS_VIV_97,
       FTN_SALDO_97,
       FTN_INTERES_SALDO_97,
       FTD_FEH_VAL_VIV,
	     CASE
         WHEN FTN_ESTATUS_DIAG = 0 THEN 0
    	     ELSE 1 END AS FTC_ESTATUS,
	     FTC_IDENTI_ASIG,
       FTC_TIPO_DEV,
       FTC_NSS_SEPAR_CTA,
       FTC_ORIGEN_DEV,
       FTN_MONTO_APORTA,
       FTN_APLIC_INT_APORTA,
       FTC_FOLIO,
       FTN_ID_ARCHIVO,
       FTC_TIPO_ARCH,
       FTN_CONTA_SERV,
	     FCN_ID_SUBPROCESO,
	     to_timestamp(from_utc_timestamp(CURRENT_TIMESTAMP, 'GMT-6')) AS FTD_FEH_CRE,
	     'DATABRICKS' AS FTC_USU_CRE,
	     FTN_NUM_CTA_INVDUAL AS FTN_CTA_AFORE,
	     FCC_VALOR_IND AS FTC_INDI_VIVI,
	     FTD_FEH_REG AS FTD_REGI_INDI,
	     CASE 
	       WHEN FTN_ESTATUS_DIAG = 0 THEN FTC_ID_DIAGNOSTICO
		       ELSE NULL END AS FCN_ID_MOTIVO_RECHAZO,
	     FTN_CELULAR AS FTC_CELULAR,
	     FTC_CORREO_ELEC,
	     ROW_NUMBER() OVER (PARTITION BY FTC_NSS_AFORE ORDER BY FTC_NSS_AFORE) AS RN
    FROM #DELTA_VIV_DUP#
)
WHERE RN = 1
