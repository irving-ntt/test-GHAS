SELECT 
  FTC_ORIGEN_TRANSFE,
  FTN_CONTA_SERV,
  FTD_FEH_PRESEN,
  FTC_CURP_TRABA,
  FTC_NSS_TRABA_INFO,
  FTN_NUM_CTA_AFORE,
  FTC_RFC_TRABA_INFO,
  FTC_APELLIDO_PATE_INFO,
  FTC_APELLIDO_MATE_INFO,
  FTC_NOMBRES_INFO,
  FTC_IDENT_LOTE_SOLI,
  FTC_NSS_TRABA_AFORE,
  FTC_RFC_TRABA_AFORE,
  FTC_APELLIDO_PATE_AFORE,
  FTC_APELLIDO_MATE_AFORE,
  FTC_NOMBRE_AFORE,
  FTN_SALDO_VIVI97_SOLI,
  FTC_CODIGO_RES_OPER,
  FTC_DIAG_PROCESO,
  FTC_NOMBRE_TRABA_IMSS,
  FTC_NUMERO_CRED_INFONA,
  FTN_PERIODO_PAGO,
  FTD_FEH_CARGA,
  FTC_FOLIO_BITACORA,
  FTC_INDI_CUENTA_VIG,
  FTD_FEH_VALOR_VIVI,
  FTC_ESTATUS,
  FTD_FEH_MOVIMIENTO,
  FTN_NUM_APLI_INTE_VIVI97_ULT,
  FTN_NUM_APLI_INTE_VIVI92_ENV,
  FTN_NUM_APLI_INTE_VIVI97_ENV,
  FTN_NUM_APLI_INTE_VIVI97_TRA,
  FTN_NUM_APLI_INTE_VIVI92_SOL,
  FTN_NUM_APLI_INTE_VIVI97_SOL,
  FTN_IDENTI_MOVTO,
  FTC_ESTATUS_REVE,
  FTN_UTLIMA_APOR_VIVI97,
  FTN_INTER_SALDO_VIVI97_ULT,
  FTN_INTER_SALDO_VIVI92,
  FTN_SALDO_TOT_VIVI92,
  FTN_NUM_AIVS_VIVI97_ULT,
  FTN_SALDO_VIVI97_ULT,
  FTN_SALDO_VIVI97_TRAN,
  -- FTN_ID_ARCHIVO,
  FTN_ID_SUBP,
  FTC_TIPO_ARCH,
  FTC_INDI_VIVI,
  FTD_FEH_REGIS_INDI,
  FTC_ESTATUS_REGISTRO,
  FTD_FEH_ACTUA_ESTATUS,
  FTN_MOTIVO_RECHAZO,
  FTD_FEH_CRE,
  FTC_USU_CRE,
  FCN_ID_SIEFORE,
  FTC_CORREO_ELEC, 
  FTC_CELULAR
FROM(
    SELECT
      FTC_ORIGEN_TRANSFE,
      FTN_CONTA_SERV,
      FTD_FEH_PRESEN,
      FTC_CURP_TRABA,
      FTC_NSS_TRABA_INFO,
      FTN_NUM_CTA_INVDUAL AS FTN_NUM_CTA_AFORE,
      FTC_RFC_TRABA_INFO,
      FTC_APELLIDO_PATE_INFO,
      FTC_APELLIDO_MATE_INFO,
      FTC_NOMBRES_INFO,
      FTC_IDENT_LOTE_SOLI,
      FTC_NSS_TRABA_AFORE,
      FTC_RFC_TRABA_AFORE,
      FTC_APELLIDO_PATE_AFORE,
      FTC_APELLIDO_MATE_AFORE,
      FTC_NOMBRE_AFORE,
      FTN_SALDO_VIVI97_SOLI,
      FTC_CODIGO_RES_OPER,
      FTC_DIAG_PROCESO,
      FTC_NOMBRE_TRABA_IMSS,
      FTC_NUMERO_CRED_INFONA,
      FTN_PERIODO_PAGO,
      current_date() AS FTD_FEH_CARGA,
      #SR_FOLIO# AS FTC_FOLIO_BITACORA,
      FTC_INDI_CUENTA_VIG,
      FTD_FEH_VALOR_VIVI,
      FTC_ESTATUS,
      FTD_FEH_MOVIMIENTO,
      FTN_NUM_APLI_INTE_VIVI97_ULT,
      FTN_NUM_APLI_INTE_VIVI92_ENV,
      FTN_NUM_APLI_INTE_VIVI97_ENV,
      FTN_NUM_APLI_INTE_VIVI97_TRA,
      FTN_NUM_APLI_INTE_VIVI92_SOL,
      FTN_NUM_APLI_INTE_VIVI97_SOL,
      FTN_IDENTI_MOVTO,
      FTC_ESTATUS_REVE,
      FTN_UTLIMA_APOR_VIVI97,
      FTN_INTER_SALDO_VIVI97_ULT,
      FTN_INTER_SALDO_VIVI92,
      FTN_SALDO_TOT_VIVI92,
      FTN_NUM_AIVS_VIVI97_ULT,
      FTN_SALDO_VIVI97_ULT,
      FTN_SALDO_VIVI97_TRAN,
      FTN_ID_ARCHIVO,
      #SR_SUBPROCESO# AS FTN_ID_SUBP,
      FTC_TIPO_ARCH,
      TRIM(FCC_VALOR_IND) AS FTC_INDI_VIVI,
      FTD_FEH_REG AS FTD_FEH_REGIS_INDI,
      CASE
        WHEN FTN_ESTATUS_DIAG = 0 THEN 0
        ELSE 1 END AS FTC_ESTATUS_REGISTRO,
      current_date() AS FTD_FEH_ACTUA_ESTATUS,
      CASE
        WHEN FTN_ESTATUS_DIAG = 0 THEN FTC_ID_DIAGNOSTICO
        ELSE null END AS FTN_MOTIVO_RECHAZO,
      to_timestamp(from_utc_timestamp(CURRENT_TIMESTAMP, 'GMT-6')) AS FTD_FEH_CRE,
      'DATABRICKS' AS FTC_USU_CRE,
      81 AS FCN_ID_SIEFORE,
      FTC_CORREO_ELEC, 
      FTN_CELULAR AS FTC_CELULAR,
    	ROW_NUMBER() OVER (PARTITION BY FTN_NUM_CTA_AFORE, FTC_NSS_TRABA_AFORE, FTN_ESTATUS_DIAG, FTN_CONTA_SERV 
                         ORDER BY FTN_NUM_CTA_AFORE ASC, FTC_NSS_TRABA_AFORE ASC, FTN_ESTATUS_DIAG ASC, FTN_CONTA_SERV ASC) AS rn
    FROM #DELTA_VIV_DUP# 
) 
WHERE rn = 1