WITH
TRANS_FOVISSSTE
 AS
(
SELECT 
TF.FTC_FOLIO,
TF.FTN_NUM_CTA_INVDUAL,
TF.FTN_CONTA_SERV,
TF.FTD_FEH_MOVIMIENTO,
TF.FTC_CURP,
TF.FTC_NSS, 
TF.FTC_ESTATUS,
TF.FTN_MOTIVO_RECHAZO,
(CASE WHEN TF.FTC_ESTATUS = 0 THEN 0 ELSE TF.FTN_NUM_APLI_INTE_VIVI92_APL END) AS FTN_NUM_APLI_INTE_VIVI92_APL,
TF.FTN_VAL_APLI_INTE_92,
(CASE WHEN TF.FTC_ESTATUS = 0 THEN 0 ELSE TF.FTN_SALDO_TOT_VIVI92_APL END) AS FTN_SALDO_TOT_VIVI92_APL,
TF.FTC_DIAG_PROCESO,
(CASE WHEN TF.FTC_ESTATUS = 0 THEN 0 ELSE TF.FTN_NUM_APLI_INTE_VIVI08_APL END) AS FTN_NUM_APLI_INTE_VIVI08_APL,
TF.FTN_VAL_APLI_INTE_08,
(CASE WHEN TF.FTC_ESTATUS = 0 THEN 0 ELSE TF.FTN_SALDO_TOT_VIVI08_APL END) AS FTN_SALDO_TOT_VIVI08_APL,
TF.FTN_NUM_APLI_INTE_VIVI08_SOL,
TF.FTN_NUM_APLI_INTE_VIVI92_SOL,
SS.FTN_VALOR_AIVS,
TF.FTN_SALDO_TOT_VIVI08,
TF.FTN_SALDO_TOT_VIVI92
FROM PROCESOS.TTAFOTRAS_TRANS_FOVISSSTE TF
LEFT JOIN PROCESOS.TTSISGRAL_SUF_SALDOS SS ON TF.FTC_FOLIO = SS.FTC_FOLIO_BITACORA 
                                           AND TF.FTN_NUM_CTA_INVDUAL = SS.FTN_NUM_CTA_INVDUAL
where TF.FTC_FOLIO = '#SR_FOLIO#' --'202108101439190646'
AND TF.FCN_ID_SUBPROCESO = #SR_SUBPROCESO#   --363
--AND FTC_ESTATUS = 1
),
CONTEO
AS
(
SELECT
FTC_FOLIO,
COUNT(*) AS FTN_CONTA_SERV
FROM PROCESOS.TTAFOTRAS_TRANS_FOVISSSTE
WHERE FTC_FOLIO = '#SR_FOLIO#'
AND FCN_ID_SUBPROCESO = #SR_SUBPROCESO#
GROUP BY FTC_FOLIO
)
SELECT 
'09' AS TIPO_REGISTRO,
LPAD(REPLACE(CANTIDAD_REG,'.',''),9,'0') AS CANTIDAD_REG,
LPAD(
  REPLACE(
  LPAD(SUBSTR(TO_CHAR(AIVS92), 1, INSTR(TO_CHAR(AIVS92, 'FM9999999999.99'), '.') - 1),12,'0') 
|| RPAD(SUBSTR(TRIM(TO_CHAR(AIVS92, 'FM9999999999.999999')||'00'),INSTR(TRIM(TO_CHAR(AIVS92, 'FM9999999999.999999')||'00'), '.') + 1, 6),6,'0')
  ,'.','')
    ,18,'0') AS AIVS92,
LPAD(
  REPLACE(
  LPAD(SUBSTR(TO_CHAR(PESOS92), 1, INSTR(TO_CHAR(PESOS92, 'FM9999999999.99'), '.') - 1),13,'0') 
|| RPAD(SUBSTR(TRIM(TO_CHAR(PESOS92, 'FM9999999999.99')||'00'),INSTR(TRIM(TO_CHAR(PESOS92, 'FM9999999999.99')||'00'), '.') + 1, 2),2,'0')
  ,'.','')
    ,15,'0') AS PESOS92,
LPAD(
  REPLACE(
  LPAD(SUBSTR(TO_CHAR(AIVS08), 1, INSTR(TO_CHAR(AIVS08, 'FM9999999999.99'), '.') - 1),12,'0') 
|| RPAD(SUBSTR(TRIM(TO_CHAR(AIVS08, 'FM9999999999.999999')||'00'),INSTR(TRIM(TO_CHAR(AIVS08, 'FM9999999999.999999')||'00'), '.') + 1, 6),6,'0')
  ,'.','')
,18,'0') AS AIVS08,
LPAD(
  REPLACE(
  LPAD(SUBSTR(TO_CHAR(PESOS08), 1, INSTR(TO_CHAR(PESOS08, 'FM9999999999.99'), '.') - 1),13,'0') 
|| RPAD(SUBSTR(TRIM(TO_CHAR(PESOS08, 'FM9999999999.99')||'00'),INSTR(TRIM(TO_CHAR(PESOS08, 'FM9999999999.99')||'00'), '.') + 1, 2),2,'0')
  ,'.','')
,15,'0') AS PESOS08,
LPAD(' ',2,' ') AS COD_RES_OPER,
LPAD(' ',3,' ') AS DIAG_PROC,
LPAD(' ',648,' ') AS FILLER
FROM
(
SELECT
T.FTC_FOLIO AS FOLIO,
(SELECT C.FTN_CONTA_SERV FROM CONTEO C WHERE T.FTC_FOLIO = C.FTC_FOLIO) AS CANTIDAD_REG,
SUM(T.FTN_NUM_APLI_INTE_VIVI08_APL) AS AIVS08,
SUM(T.FTN_NUM_APLI_INTE_VIVI92_APL) AS AIVS92,
SUM(T.FTN_SALDO_TOT_VIVI08_APL) AS PESOS08,
SUM(T.FTN_SALDO_TOT_VIVI92_APL) AS PESOS92
FROM TRANS_FOVISSSTE T
GROUP BY
T.FTC_FOLIO
)